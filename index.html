<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Universal Business Marketplace — Single File App</title>

  <!-- Modern system font fallback; you can swap for Google Fonts if online -->
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700&display=swap" rel="stylesheet">

  <style>
    :root{
      --green:#1DB954;         /* fresher green */
      --green-600:#16a34a;
      --orange:#FF6A00;       /* warmer orange */
      --bg:#f5f7fb;
      --card:#ffffff;
      --muted:#6b7280;
      --radius:14px;
      --glass: rgba(255,255,255,0.65);
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0;
      font-family: Inter, system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial;
      background: linear-gradient(180deg, #f7fafc 0%, var(--bg) 100%);
      color:#0f172a;
      -webkit-font-smoothing:antialiased;
      -moz-osx-font-smoothing:grayscale;
      -webkit-tap-highlight-color: transparent;
      line-height:1.45;
    }

    /* Header (sticky so CTA never gets hidden) */
    header{
      position: sticky;
      top: 0;
      z-index: 99999;
      display:flex;
      align-items:center;
      gap:16px;
      padding:14px 18px;
      background: linear-gradient(90deg, var(--green), #4caf50 60%);
      color: #fff;
      box-shadow: 0 6px 18px rgba(16,24,40,0.06);
    }
    .brand{
      display:flex;
      gap:12px;
      align-items:center;
    }
    .logo {
      width:42px;height:42px;border-radius:10px;
      box-shadow:0 6px 18px rgba(0,0,0,0.12);
      display:flex;align-items:center;justify-content:center;
      background: linear-gradient(135deg, rgba(255,255,255,0.12), rgba(255,255,255,0.06));
      font-weight:700;font-size:18px;
    }
    .brand h1{font-size:18px;margin:0}
    .nav{margin-left:auto;display:flex;gap:10px;align-items:center}
    .nav a{color:rgba(255,255,255,0.95);text-decoration:none;padding:8px 12px;border-radius:10px;font-weight:600}
    .nav a:hover{background:rgba(255,255,255,0.06)}

    /* Voyager CTA placed at the far left of the nav area (always visible) */
    .voyager-btn{
      background: #ffffff;
      color: var(--green-600);
      font-weight:800;
      padding:8px 14px;
      border-radius:999px;
      border:2px solid rgba(255,255,255,0.12);
      text-decoration:none;
      display:inline-flex;
      align-items:center;
      gap:8px;
      cursor:pointer;
      box-shadow: 0 8px 30px rgba(2,6,23,0.12);
      white-space:nowrap;
    }
    .voyager-btn:active{ transform: translateY(1px) }
    .voyager-btn:focus { outline: 3px solid rgba(255,255,255,0.18); outline-offset: 2px; }

    /* Container */
    .container{padding:22px;max-width:1200px;margin:0 auto}

    /* Search + filters */
    .topbar{display:flex;gap:12px;align-items:center;margin-bottom:18px;flex-wrap:wrap}
    .search{
      flex:1;display:flex;align-items:center;background:var(--card);padding:10px;border-radius:12px;box-shadow:0 6px 18px rgba(16,24,40,0.04);
      border:1px solid rgba(15,23,42,0.03);
    }
    .search input{border:0;outline:none;font-size:15px;padding:6px 8px;width:100%}
    .search .icon{opacity:0.6;margin-right:8px}
    .filters{display:flex;gap:8px;align-items:center}
    .pill{background:transparent;border:1px solid rgba(15,23,42,0.06);padding:8px 10px;border-radius:999px;font-weight:600;cursor:pointer}
    .pill.active{background:linear-gradient(90deg,var(--green),#4caf50);color:white;border-color:transparent}

    /* Products grid */
    .products{display:grid;grid-template-columns:repeat(auto-fill,minmax(220px,1fr));gap:18px;margin-top:6px}
    .card{
      background:linear-gradient(180deg, var(--card), #fff);
      border-radius:12px;overflow:hidden;display:flex;flex-direction:column;transition:transform .18s ease, box-shadow .18s;
      box-shadow: 0 8px 24px rgba(16,24,40,0.06);
      border:1px solid rgba(15,23,42,0.03);
    }
    .card:hover{ transform: translateY(-6px); box-shadow: 0 18px 48px rgba(16,24,40,0.08); }
    .media{height:150px;background:#f3f4f6;display:flex;align-items:center;justify-content:center;overflow:hidden}
    .media img{width:100%;height:100%;object-fit:cover}
    .card .body{padding:14px;display:flex;flex-direction:column;gap:8px;flex:1}
    .title{font-weight:700;font-size:15px}
    .meta{font-size:13px;color:var(--muted)}
    .price{color:var(--orange);font-weight:800;font-size:16px}
    .bottom{display:flex;gap:8px;margin-top:auto;align-items:center}
    .btn{padding:10px 12px;border-radius:10px;border:0;cursor:pointer;font-weight:700}
    .btn.primary{background:var(--green);color:white;flex:1}
    .btn.ghost{background:transparent;border:1px solid rgba(15,23,42,0.06);color:#0f172a;flex:1}

    /* badges */
    .ribbon{position:absolute;margin:12px 0 0 -12px;background:var(--orange);color:white;padding:6px 10px;border-radius:8px;font-weight:700;font-size:12px;box-shadow:0 6px 18px rgba(0,0,0,0.08)}
    .lowstock{background:#ffb020;color:#4b2b00}
    .soldout{background:#9e9e9e;color:#fff}

    /* product footer row */
    .card-footer{display:flex;justify-content:space-between;align-items:center;padding:10px 14px;border-top:1px solid rgba(15,23,42,0.03);background:linear-gradient(180deg, rgba(0,0,0,0.01), transparent)}

    /* modal */
    .modal-backdrop{position:fixed;inset:0;background:rgba(2,6,23,0.5);display:none;align-items:center;justify-content:center;padding:20px;z-index:9999}
    .modal-sheet{background:var(--card);width:100%;max-width:640px;border-radius:12px;overflow:hidden;box-shadow:0 40px 120px rgba(2,6,23,0.4)}
    .modal-head{padding:18px;border-bottom:1px solid rgba(15,23,42,0.03);display:flex;align-items:center;justify-content:space-between}
    .modal-body{padding:18px}
    .modal-foot{padding:12px 18px;border-top:1px solid rgba(15,23,42,0.03);display:flex;gap:8px;justify-content:flex-end}

    /* chat UI small tweaks */
    .chat-wrap{display:flex;height:60vh;background:var(--card);border-radius:12px;overflow:hidden}
    .chat-sidebar{width:280px;border-right:1px solid #f1f5f9;padding:8px;display:flex;flex-direction:column}
    .messages{flex:1;padding:16px;overflow:auto;background:linear-gradient(180deg,#fbfdff,#ffffff)}
    .msg{max-width:72%;padding:10px;border-radius:12px;margin-bottom:8px;box-shadow:0 6px 18px rgba(12,18,31,0.04)}
    .msg.me{background:var(--green);color:white;margin-left:auto;border-bottom-right-radius:2px}
    .msg.them{background:#f3f4f6;margin-right:auto;color:#111}

    /* toast */
    .toast{position:fixed;right:20px;bottom:20px;background:rgba(2,6,23,0.9);color:white;padding:12px 14px;border-radius:12px;display:none;opacity:0;transform:translateY(8px);transition:opacity .2s, transform .2s}

    /* responsive */
    @media(max-width:900px){ .products{grid-template-columns:repeat(auto-fill,minmax(180px,1fr))} }
    @media(max-width:680px){
      .nav{display:flex;gap:8px} /* keep nav visible on small screens */
      .topbar{flex-direction:column;align-items:stretch}
      .search{width:100%}
      .grid-two{grid-template-columns:1fr}
      /* keep container readable on small screens */
      .container{padding-bottom:90px}
    }
  </style>
</head>
<body>
  <header>
    <div class="brand">
      <div class="logo">UB</div>
      <div>
        <h1>Universal Business Marketplace</h1>
        <div style="font-size:12px;color:rgba(255,255,255,0.9)">Sell anything. One storefront for every business.</div>
      </div>
    </div>

    <!-- Voyager CTA — placed in header so it never gets blocked -->
    <div style="margin-left:18px">
      <button id="voyagerBtn" class="voyager-btn" aria-label="New — Voyager Go">New — Voyager Go</button>
    </div>

    <nav class="nav" aria-label="Main navigation">
      <a href="#/">Home</a>
      <a href="#/contact">Contact</a>
      <!-- Admin link intentionally omitted for security -->
    </nav>
  </header>

  <main class="container" id="app" role="main" aria-live="polite">
    <!-- rendered by JS -->
  </main>

  <!-- Modal -->
  <div class="modal-backdrop" id="modal" aria-hidden="true">
    <div class="modal-sheet" role="dialog" aria-modal="true">
      <div class="modal-head"><div id="modalTitle"></div><div><button id="modalClose" class="btn ghost">Close</button></div></div>
      <div class="modal-body" id="modalBody"></div>
      <div class="modal-foot" id="modalFoot"></div>
    </div>
  </div>

  <div class="toast" id="toast" role="status" aria-live="polite"></div>

<script>
/* Modernized storefront (appearance-first) — fully compatible with admin.html localStorage keys
   Keys: mb_products, mb_orders, mb_messages
*/
const uid = () => 'id_'+Math.random().toString(36).slice(2,9);
const now = ()=> new Date().toISOString();
const db = {
  load(k, fallback){ try{const v = localStorage.getItem(k); return v?JSON.parse(v):fallback}catch(e){return fallback} },
  save(k,v){ localStorage.setItem(k,JSON.stringify(v)); window.dispatchEvent(new Event('storage')); }
};

// Seed minimal products if empty (unchanged)
if(!db.load('mb_products',null)){
  const seed = [
    {id:uid(),name:'Fresh Apples',price:300,category:'Food',image:'https://images.unsplash.com/photo-1567306226416-28f0efdc88ce?auto=format&fit=crop&w=800&q=60',stock:50,desc:'Sweet farm apples'},
    {id:uid(),name:"Men's Shoes",price:2500,category:'Fashion',image:'https://images.unsplash.com/photo-1528701800489-20be0c2a90d4?auto=format&fit=crop&w=800&q=60',stock:12,desc:'Comfortable everyday shoes'},
    {id:uid(),name:'Beauty Lotion',price:800,category:'Beauty',image:'https://images.unsplash.com/photo-1600180758890-6d3a57880a6b?auto=format&fit=crop&w=800&q=60',stock:30,desc:'Moisturizing lotion 200ml'}
  ];
  db.save('mb_products',seed);
}
if(!db.load('mb_orders',null)) db.save('mb_orders',[]);
if(!db.load('mb_messages',null)) db.save('mb_messages',[]);

function getProducts(){ return db.load('mb_products',[]) }
function saveProducts(p){ db.save('mb_products',p) }
function getOrders(){ return db.load('mb_orders',[]) }
function saveOrders(o){ db.save('mb_orders',o) }
function getMessages(){ return db.load('mb_messages',[]) }
function saveMessages(m){ db.save('mb_messages',m) }

const app = document.getElementById('app');

function router(){
  const hash = location.hash.replace(/^#\/|^#/,'') || '';
  const [path, qs] = hash.split('?');
  const params = new URLSearchParams(qs||'');
  if(path.startsWith('contact')) renderContact(params.get('phone'));
  else renderHome();
}
window.addEventListener('hashchange', router);
router();

/* ====== Home / Marketplace (pretty) ====== */
function renderHome(){
  const products = getProducts();
  const categories = ['All',...Array.from(new Set(products.map(p=>p.category)))];

  app.innerHTML = `
    <div class="topbar">
      <div class="search" role="search" aria-label="Search products">
        <svg class="icon" width="18" height="18" viewBox="0 0 24 24" fill="none" style="opacity:0.7">
          <path d="M21 21l-4.35-4.35" stroke="#0f172a" stroke-width="1.6" stroke-linecap="round" stroke-linejoin="round"/>
          <circle cx="11" cy="11" r="5" stroke="#0f172a" stroke-width="1.6" fill="none"/>
        </svg>
        <input id="q" placeholder="Search products, e.g. 'apples' or 'shoes'"/>
        <button id="clear" class="pill" title="Reset filters">Reset</button>
      </div>

      <div class="filters" id="filtersRow">
        ${categories.map((c,i)=>`<button class="pill ${i===0? 'active':''}" data-cat="${encodeURIComponent(c)}">${escapeHtml(c)}</button>`).join('')}
      </div>
    </div>

    <div class="products" id="productList"></div>
  `;

  // events
  document.getElementById('q').addEventListener('input', ()=> drawProducts());
  document.querySelectorAll('#filtersRow .pill').forEach(btn=>{
    btn.addEventListener('click', (e)=>{
      document.querySelectorAll('#filtersRow .pill').forEach(b=>b.classList.remove('active'));
      e.currentTarget.classList.add('active');
      drawProducts();
    });
  });
  document.getElementById('clear').addEventListener('click', ()=>{ document.getElementById('q').value=''; document.querySelectorAll('#filtersRow .pill').forEach((b,i)=>{ if(i===0) b.classList.add('active'); else b.classList.remove('active'); }); drawProducts(); });
  drawProducts();

  // if user has unread messages
  const userPhone = sessionStorage.getItem('mb_phone');
  if(userPhone){
    const unread = getMessages().filter(m=>m.to===userPhone && m.from==='admin' && !m.read).length;
    if(unread) showToast(`You have ${unread} new message(s) from Admin`);
  }
}

function drawProducts(){
  const q = (document.getElementById('q')||{}).value ? document.getElementById('q').value.toLowerCase() : '';
  const catBtn = document.querySelector('#filtersRow .pill.active');
  const cat = catBtn ? catBtn.textContent : 'All';
  const pts = getProducts().filter(p=>{
    if(cat!=='All' && p.category !== cat) return false;
    if(q && !(p.name.toLowerCase().includes(q) || (p.desc||'').toLowerCase().includes(q))) return false;
    return true;
  });

  const list = document.getElementById('productList');
  list.innerHTML = pts.map(p=>{
    const low = (p.stock||0) <= 5 && (p.stock||0) > 0;
    const soldOut = (p.stock||0) <= 0;
    return `
      <div class="card" data-id="${p.id}">
        <div style="position:relative">
          ${ low ? `<div class="ribbon lowstock">Low</div>` : '' }
          ${ soldOut ? `<div class="ribbon soldout">Sold</div>` : '' }
          <div class="media"><img alt="${escapeHtml(p.name)}" src="${escapeHtml(p.image||'https://via.placeholder.com/600')}" /></div>
        </div>
        <div class="body">
          <div class="title">${escapeHtml(p.name)}</div>
          <div class="meta">${escapeHtml(p.category)} • <span style="color:var(--muted)">Stock: ${p.stock||0}</span></div>
          <div style="display:flex;align-items:center;justify-content:space-between;gap:10px">
            <div class="price">KSh ${formatNumber(p.price)}</div>
            <div class="meta">ID: <span style="font-weight:600">${p.id.slice(0,6)}</span></div>
          </div>
          <div style="color:var(--muted);font-size:13px;margin-top:6px">${escapeHtml(p.desc||'')}</div>

          <div class="card-footer" style="margin-top:10px">
            <button class="btn primary" onclick="openOrder('${p.id}')">Order</button>
            <button class="btn ghost" onclick="orderWhatsApp('${p.id}')">WhatsApp</button>
          </div>
        </div>
      </div>
    `;
  }).join('') || `<div style="padding:40px;color:var(--muted)">No products found</div>`;
}

/* ====== Utilities for currency + formatting ====== */
function formatNumber(n){ try{ return Number(n).toLocaleString('en-KE'); }catch(e){ return n } }

/* ===== Modals (pretty) ====== */
const modalBackdrop = document.getElementById('modal');
const modalTitle = document.getElementById('modalTitle');
const modalBody = document.getElementById('modalBody');
const modalFoot = document.getElementById('modalFoot');
document.getElementById('modalClose').addEventListener('click', closeModal);

function openModal(title, html, footHtml){
  modalTitle.innerHTML = title || '';
  modalBody.innerHTML = html || '';
  modalFoot.innerHTML = footHtml || '';
  modalBackdrop.style.display = 'flex';
  modalBackdrop.querySelector('.modal-sheet').scrollTop = 0;
  modalBackdrop.setAttribute('aria-hidden','false');
}
function closeModal(){ modalBackdrop.style.display = 'none'; modalBackdrop.setAttribute('aria-hidden','true'); }

/* ====== Order flow (in-app) ====== */
function openOrder(productId){
  const p = getProducts().find(x=>x.id===productId);
  if(!p) return;
  openModal(
    `Order — ${escapeHtml(p.name)}`,
    `
      <div style="display:flex;gap:12px;flex-direction:column">
        <label style="font-weight:600">Your name <input id="order_name" placeholder="Full name" style="width:100%;margin-top:6px;padding:10px;border-radius:10px;border:1px solid #eee" /></label>
        <label style="font-weight:600">Your phone <input id="order_phone" placeholder="e.g. 254712345678" style="width:100%;margin-top:6px;padding:10px;border-radius:10px;border:1px solid #eee" /></label>
        <div style="display:flex;gap:8px">
          <label style="flex:1">Quantity <input id="order_qty" type="number" value="1" min="1" max="${p.stock||999}" style="width:100%;margin-top:6px;padding:10px;border-radius:10px;border:1px solid #eee" /></label>
          <label style="flex:1">Paid now? <select id="order_paid" style="width:100%;margin-top:6px;padding:10px;border-radius:10px;border:1px solid #eee"><option value="false">No</option><option value="true">Yes</option></select></label>
        </div>
        <label>Optional note <input id="order_note" placeholder="Delivery info, landmark..." style="width:100%;margin-top:6px;padding:10px;border-radius:10px;border:1px solid #eee" /></label>
      </div>
    `,
    `<button class="btn ghost" onclick="closeModal()">Cancel</button>
     <button class="btn primary" id="confirmOrderBtn">Send Order</button>`
  );

  // wire confirm button
  document.getElementById('confirmOrderBtn').addEventListener('click', ()=>{
    const name = document.getElementById('order_name').value.trim();
    const phone = document.getElementById('order_phone').value.trim();
    const qty = parseInt(document.getElementById('order_qty').value,10) || 1;
    const note = document.getElementById('order_note').value.trim();
    const paid = document.getElementById('order_paid').value === 'true';
    if(!name || !phone){ alert('Please provide name and phone'); return; }

    sessionStorage.setItem('mb_phone', phone);

    // Create order object (explicit paid flag)
    const order = {
      id: uid(),
      productId,
      productName: p.name,
      price: p.price,
      qty,
      items: [{ name: p.name, qty, price: p.price }],
      note,
      customerName: name,
      customerPhone: phone,
      paid: !!paid,
      status: 'Pending',
      history: [{ at: now(), status: 'Pending' }],
      createdAt: now(),
      unread: true
    };

    const orders = getOrders(); orders.unshift(order); saveOrders(orders);

    // Notify admin via message record
    const msg = {
      id: uid(),
      from: phone,
      to: 'admin',
      text: `New order: ${p.name} x${qty} — ${name} (${phone}). Note: ${note||'-'}`,
      time: now(),
      read: false
    };
    const ms = getMessages(); ms.push(msg); saveMessages(ms);

    closeModal();
    showToast('Order sent — Admin will contact you in your Contact room');
    // Open contact room after a short delay
    setTimeout(()=>{ location.hash = `#/contact?phone=${encodeURIComponent(phone)}` }, 700);
  });
}

/* ====== Order via WhatsApp (convenience) ====== */
function orderWhatsApp(productId){
  const p = getProducts().find(x=>x.id===productId);
  if(!p) return;
  // A convenient prefilled message. Admin phone not required — user can choose recipient.
  const text = encodeURIComponent(`Hi, I'd like to order: ${p.name} — KSh ${p.price}. Please advise availability and delivery. Thanks.`);
  // open web.whatsapp with prefilled text (user picks recipient)
  const url = `https://wa.me/?text=${text}`;
  window.open(url, '_blank');
}

/* ====== Contact / Chat (user) ====== */
function renderContact(phone){
  const storedPhone = phone || sessionStorage.getItem('mb_phone') || '';
  app.innerHTML = `
    <h2>Contact Admin</h2>
    <p class="meta">This chat is a private 1:1 room between you and Admin. Use your phone number to identify your room.</p>
    <div style="margin:10px 0;display:flex;gap:8px;flex-wrap:wrap">
      <input id="contact_phone" placeholder="Your phone (e.g. 2547...)" value="${escapeHtml(storedPhone)}" style="padding:10px;border-radius:10px;border:1px solid #eee" />
      <button class="pill" id="startRoom">Open Room</button>
      <button class="pill" id="openOrders">My Orders</button>
    </div>
    <div id="chatArea"></div>
  `;
  document.getElementById('startRoom').addEventListener('click', ()=>{
    const p = document.getElementById('contact_phone').value.trim();
    if(!p){ alert('Enter phone'); return; }
    sessionStorage.setItem('mb_phone', p);
    renderChatRoom(p);
  });
  document.getElementById('openOrders').addEventListener('click', ()=> renderUserOrders(storedPhone || sessionStorage.getItem('mb_phone')));
  if(storedPhone) renderChatRoom(storedPhone);
}

function renderUserOrders(phone){
  const orders = getOrders().filter(o => o.customerPhone === phone);
  const area = document.getElementById('chatArea');
  if(!area) return;
  if(!orders.length){
    area.innerHTML = `<div style="padding:14px;background:var(--card);border-radius:12px">No orders found for ${escapeHtml(phone||'')}</div>`;
    return;
  }
  area.innerHTML = `<div style="display:flex;flex-direction:column;gap:8px">${orders.map(o=>`
    <div style="padding:12px;border-radius:10px;background:#fff;border:1px solid rgba(15,23,42,0.03)">
      <div style="display:flex;justify-content:space-between;align-items:center">
        <div><strong>${escapeHtml(o.productName)}</strong> x${o.qty}</div>
        <div style="text-align:right"><div style="font-weight:700">KSh ${formatNumber((o.price||0)*(o.qty||1))}</div><div class="meta">${escapeHtml(o.status)}</div></div>
      </div>
      <div style="margin-top:8px;font-size:13px;color:var(--muted)">Ordered: ${new Date(o.createdAt).toLocaleString()} — Paid: ${o.paid? 'Yes':'No'}</div>
      <div style="margin-top:8px;font-size:13px;color:var(--muted)">Note: ${escapeHtml(o.note||'-')}</div>
    </div>`).join('')}</div>`;
}

/* ===== Chat room UI (user) ===== */
function renderChatRoom(phone){
  // mark admin->phone messages read
  const msgsAll = getMessages().map(m=>{ if(m.to===phone && m.from==='admin') m.read = true; return m; }); saveMessages(msgsAll);

  const chatArea = document.getElementById('chatArea');
  chatArea.innerHTML = `
    <div class="chat-wrap">
      <div class="chat-sidebar">
        <div style="font-weight:700;padding:6px">${escapeHtml(phone)}</div>
        <div class="meta" style="padding:6px">Admin replies appear here. Messages sync across tabs.</div>
        <div style="margin-top:auto;padding:6px"><a href="#/">Back to shop</a></div>
      </div>

      <div class="chat-room" style="display:flex;flex-direction:column;flex:1">
        <div class="messages" id="messagesList"></div>
        <div style="padding:12px;border-top:1px solid #f1f5f9;display:flex;gap:8px;align-items:center">
          <input id="msgInput" placeholder="Type a message to admin" style="flex:1;padding:10px;border-radius:10px;border:1px solid #eee" />
          <button class="btn primary" id="sendMsg">Send</button>
        </div>
      </div>
    </div>
  `;

  function drawMsgs(){
    const list = document.getElementById('messagesList');
    const msgsNow = getMessages().filter(m=> (m.from===phone && m.to==='admin') || (m.from==='admin' && m.to===phone));
    list.innerHTML = msgsNow.map(m=>`<div class="msg ${m.from===phone? 'me':'them'}"><div style="font-size:12px;color:rgba(0,0,0,0.6);margin-bottom:6px">${m.from===phone? 'You':'Admin'}</div><div>${escapeHtml(m.text)}</div><div style="font-size:11px;color:rgba(0,0,0,0.45);margin-top:6px">${new Date(m.time).toLocaleString()}</div></div>`).join('');
    list.scrollTop = list.scrollHeight;
  }
  drawMsgs();

  document.getElementById('sendMsg').addEventListener('click', ()=>{
    const txt = document.getElementById('msgInput').value.trim(); if(!txt) return;
    const message = {id:uid(),from:phone,to:'admin',text:txt,time:now(),read:false};
    const ms = getMessages(); ms.push(message); saveMessages(ms);
    document.getElementById('msgInput').value=''; drawMsgs(); showToast('Message sent to Admin');
  });

  // cross-tab storage updating
  window.addEventListener('storage', ()=>{ drawMsgs(); });
  const poll = setInterval(drawMsgs,1500);
  const cleanup = ()=>{ clearInterval(poll); window.removeEventListener('hashchange', cleanup); window.removeEventListener('beforeunload', cleanup); };
  window.addEventListener('hashchange', cleanup); window.addEventListener('beforeunload', cleanup);
}

/* ====== Toast helper (nice) ====== */
const toastEl = document.getElementById('toast');
let toastTimer = null;
function showToast(text, time=3000){
  toastEl.textContent = text;
  toastEl.style.display = 'block';
  requestAnimationFrame(()=>{ toastEl.style.opacity = '1'; toastEl.style.transform = 'translateY(0)'; });
  if(toastTimer) clearTimeout(toastTimer);
  toastTimer = setTimeout(()=>{ toastEl.style.opacity = '0'; toastEl.style.transform = 'translateY(8px)'; setTimeout(()=>{ toastEl.style.display='none'; },200) }, time);
}

/* ====== Utilities ====== */
function escapeHtml(text){ if(!text) return ''; return String(text).replace(/[&<>"']/g, c=>({"&":"&amp;","<":"&lt;",">":"&gt;","\"":"&quot;","'":"&#39;"}[c])); }

/* ====== Admin integration & live updates ======
   - watches localStorage events (admin may update products/orders/messages)
   - refresh product grid and notify user
*/
let lastProductsJSON = JSON.stringify(getProducts());
window.addEventListener('storage', (e)=>{
  try{
    if(!e.key || e.key === 'mb_products'){
      const curr = JSON.stringify(getProducts());
      if(curr !== lastProductsJSON){ lastProductsJSON = curr; drawProducts(); showToast('Product list updated'); }
    }
    if(!e.key || e.key === 'mb_messages'){
      const phone = sessionStorage.getItem('mb_phone');
      if(phone){
        const msgs = getMessages().filter(m=>m.to===phone && m.from==='admin' && !m.read);
        if(msgs.length) showToast(`New message from Admin: ${msgs[0].text}`,5000);
      }
    }
    if(!e.key || e.key === 'mb_orders'){
      const phone = sessionStorage.getItem('mb_phone');
      if(phone){
        const orders = getOrders().filter(o=>o.customerPhone===phone);
        if(orders.length) showToast('Your order list updated (Contact → My Orders)',4000);
      }
    }
  }catch(err){}
});

// fallback poll for environments that don't send storage events reliably
setInterval(()=>{ const curr = JSON.stringify(getProducts()); if(curr !== lastProductsJSON){ lastProductsJSON = curr; drawProducts(); showToast('Product list updated'); } },3000);

/* ===== Hidden convenience: Ctrl+Shift+K opens admin.html (on your machine) ===== */
document.addEventListener('keydown', (e)=>{ if(e.ctrlKey && e.shiftKey && e.key && e.key.toLowerCase() === 'k'){ window.location.href = 'admin.html'; } });

/* ===== Voyager CTA wiring (header button) ===== */
document.getElementById('voyagerBtn').addEventListener('click', ()=>{
  // navigate to app home (router uses hash)
  location.hash = '/';
  // focus the search input on mobile/desktop after a short delay
  setTimeout(()=>{ const q = document.getElementById('q'); if(q) q.focus(); }, 250);
});
</script>
</body>
</html>
