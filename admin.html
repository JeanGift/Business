<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Marketplace — Admin (Final)</title>
  <style>
    :root{--green:#4CAF50;--orange:#FF9800;--bg:#f6f7f8;--card:#fff}
    *{box-sizing:border-box}
    body{font-family:Inter,system-ui,Arial,sans-serif;margin:0;background:var(--bg);color:#111}
    header{background:linear-gradient(90deg,var(--green),#66bb6a);padding:12px 16px;color:white;display:flex;align-items:center;gap:12px}
    .brand{font-weight:700}
    .container{max-width:1200px;margin:18px auto;padding:0 16px}
    .panel{background:var(--card);padding:14px;border-radius:10px;box-shadow:0 6px 18px rgba(0,0,0,0.06)}
    .row{display:flex;gap:12px;align-items:center}
    button{cursor:pointer}
    .btn-primary{background:var(--green);color:white;border:none;padding:8px 12px;border-radius:8px}
    .btn-ghost{background:transparent;border:1px solid #e6e6e6;padding:8px 12px;border-radius:8px}
    table{width:100%;border-collapse:collapse;margin-top:12px}
    th,td{padding:8px;border-bottom:1px solid #f3f3f3;text-align:left}
    .chip{display:inline-block;padding:6px 8px;border-radius:999px;font-size:12px}
    .small{font-size:13px;color:#666}
    .actions button{margin-right:6px}
    input,textarea,select{padding:8px;border-radius:8px;border:1px solid #e8e8e8}
    .grid{display:grid;grid-template-columns:1fr 400px;gap:14px}
    @media(max-width:980px){.grid{grid-template-columns:1fr}}
    .logs{max-height:240px;overflow:auto}
    .searchbar{display:flex;gap:8px;margin-bottom:8px}
    .file-input{display:none}
    .thumb{width:80px;height:60px;object-fit:cover;border-radius:6px;border:1px solid #eee}
    .report-card{padding:12px;border-radius:8px;background:#fafafa;margin-bottom:8px}
  </style>
</head>
<body>
  <header>
    <div class="brand">Marketplace — Admin</div>
    <div style="margin-left:auto"><a href="index.html" style="color:white;text-decoration:underline">Open Storefront</a></div>
  </header>
  <main class="container">
    <div id="root"></div>
  </main>

<script>
/* Final Admin dashboard
   - Password-protected (setup/login/reset)
   - Manage products (add with image upload or URL), visible to index.html via localStorage mb_products
   - View & process orders (approve, progress status, mark delivered/received), undo last action
   - Read user messages and reply (mb_messages)
   - Reports: orders by status, total sales, recent orders
   - CSV export/import for products & orders
*/

const uid = ()=> 'id_'+Math.random().toString(36).slice(2,9);
const now = ()=> new Date().toISOString();
const db = {
  load(k,f){ try{const v=localStorage.getItem(k); return v?JSON.parse(v):f}catch(e){return f} },
  save(k,v){ localStorage.setItem(k,JSON.stringify(v)); window.dispatchEvent(new Event('storage')); }
}
if(!db.load('mb_products',null)) db.save('mb_products',[]);
if(!db.load('mb_orders',null)) db.save('mb_orders',[]);
if(!db.load('mb_messages',null)) db.save('mb_messages',[]);

function getProducts(){ return db.load('mb_products',[]) }
function saveProducts(p){ db.save('mb_products',p) }
function getOrders(){ return db.load('mb_orders',[]) }
function saveOrders(o){ db.save('mb_orders',o) }
function getMessages(){ return db.load('mb_messages',[]) }
function saveMessages(m){ db.save('mb_messages',m) }

const root = document.getElementById('root');
function render(){
  const isAuthed = sessionStorage.getItem('mb_admin_auth') === 'true';
  const storedPass = localStorage.getItem('mb_admin_pass');

  if(!isAuthed){
    if(!storedPass){
      root.innerHTML = `
        <div class="panel">
          <h2>Admin — Initial setup</h2>
          <p>Create a secure password to protect the admin dashboard in this browser.</p>
          <div style="display:flex;flex-direction:column;gap:8px;max-width:420px">
            <input id="new_pass" type="password" placeholder="New password (min 6 chars)" />
            <input id="new_pass2" type="password" placeholder="Confirm password" />
            <div style="display:flex;gap:8px"><button class="btn-primary" id="save_pass">Save</button><button class="btn-ghost" id="cancel_setup">Cancel</button></div>
          </div>
        </div>
      `;
      document.getElementById('save_pass').addEventListener('click', ()=>{
        const a=document.getElementById('new_pass').value; const b=document.getElementById('new_pass2').value;
        if(!a||a.length<6){ alert('Choose a password with at least 6 characters'); return; }
        if(a!==b){ alert('Passwords do not match'); return; }
        localStorage.setItem('mb_admin_pass', a); sessionStorage.setItem('mb_admin_auth','true'); render();
      });
      document.getElementById('cancel_setup').addEventListener('click', ()=>{ location.href='index.html'; });
      return;
    }

    root.innerHTML = `
      <div class="panel">
        <h2>Admin — Login</h2>
        <div style="max-width:420px;display:flex;flex-direction:column;gap:8px">
          <input id="login_pass" type="password" placeholder="Enter admin password" />
          <div style="display:flex;gap:8px"><button class="btn-primary" id="do_login">Login</button><button class="btn-ghost" id="reset_pass">Reset</button></div>
          <div class="small">Reset will clear the saved password and require setup again.</div>
        </div>
      </div>
    `;
    document.getElementById('do_login').addEventListener('click', ()=>{
      const v=document.getElementById('login_pass').value||''; const s=localStorage.getItem('mb_admin_pass')||'';
      if(v===s){ sessionStorage.setItem('mb_admin_auth','true'); render(); } else alert('Incorrect');
    });
    document.getElementById('reset_pass').addEventListener('click', ()=>{ if(confirm('Clear saved admin password?')){ localStorage.removeItem('mb_admin_pass'); alert('Password cleared'); render(); } });
    return;
  }

  // Authenticated admin UI
  root.innerHTML = `
    <div class="grid">
      <div>
        <div class="panel">
          <div style="display:flex;justify-content:space-between;align-items:center"><h3>Orders</h3>
            <div class="row">
              <select id="orderStatusFilter"><option value="">All statuses</option><option>Pending</option><option>Confirmed</option><option>Preparing</option><option>Shipped</option><option>Delivered</option><option>Received</option><option>Cancelled</option></select>
              <input id="orderQ" placeholder="Search product/customer/phone" />
              <button class="btn-primary" id="applyOrdersFilter">Filter</button>
            </div>
          </div>
          <div id="ordersArea" class="small" style="margin-top:10px"></div>
        </div>

        <div class="panel" style="margin-top:12px">
          <h3>Products</h3>
          <div style="display:flex;gap:8px;margin-bottom:8px;align-items:center"><button class="btn-primary" id="showAddProduct">Add product</button><button class="btn-ghost" id="exportProducts">Export CSV</button><label class="btn-ghost" style="cursor:pointer"><input id="importProductsFile" class="file-input" type="file" accept=".csv" />Import CSV</label><button class="btn-ghost" id="refreshProducts">Refresh</button></div>
          <div id="productsArea" class="small"></div>
        </div>
      </div>

      <div>
        <div class="panel">
          <h3>Messages / Rooms</h3>
          <div style="display:flex;gap:8px;margin-bottom:8px"><input id="roomFilter" placeholder="Filter rooms" /><button class="btn-primary" id="viewRooms">View Rooms</button></div>
          <div id="roomsArea" class="small"></div>
        </div>

        <div class="panel" style="margin-top:12px">
          <h3>Quick Message</h3>
          <div style="display:flex;flex-direction:column;gap:8px"><input id="msg_to" placeholder="Customer phone e.g. 2547..." /><textarea id="msg_text" placeholder="Message to customer"></textarea><div style="display:flex;gap:8px"><button class="btn-primary" id="sendMsg">Send</button><button class="btn-ghost" id="logout">Logout</button></div></div>
        </div>

        <div class="panel" style="margin-top:12px">
          <h3>Reports</h3>
          <div id="reportsArea"></div>
        </div>

        <div class="panel" style="margin-top:12px">
          <h3>Activity / Logs</h3>
          <div id="logs" class="logs small"></div>
        </div>
      </div>
    </div>
  `;

  // Event bindings
  document.getElementById('logout').addEventListener('click', ()=>{ if(confirm('Logout?')){ sessionStorage.removeItem('mb_admin_auth'); render(); } });
  document.getElementById('showAddProduct').addEventListener('click', ()=> openAddProduct());
  document.getElementById('refreshProducts').addEventListener('click', ()=> renderProducts());
  document.getElementById('applyOrdersFilter').addEventListener('click', ()=> renderOrders());
  document.getElementById('viewRooms').addEventListener('click', ()=> renderRooms());
  document.getElementById('sendMsg').addEventListener('click', ()=> sendQuickMessage());
  document.getElementById('exportProducts').addEventListener('click', ()=> exportProductsCSV());
  document.getElementById('importProductsFile').addEventListener('change', (e)=> handleCSVImport(e.target.files[0],'products'));

  renderOrders(); renderProducts(); renderRooms(); renderReports(); renderLogs();
}

/* ===== Orders management ===== */
function renderOrders(){
  const orders = getOrders();
  const status = document.getElementById('orderStatusFilter').value || '';
  const q = (document.getElementById('orderQ').value||'').toLowerCase().trim();
  const filtered = orders.filter(o=>{
    if(status && o.status !== status) return false;
    if(q){ if((o.productName||'').toLowerCase().includes(q)) return true; if((o.customerName||'').toLowerCase().includes(q)) return true; if((o.customerPhone||'').toLowerCase().includes(q)) return true; return false; }
    return true;
  });
  const area = document.getElementById('ordersArea'); if(!area) return;
  area.innerHTML = filtered.length? `<table><thead><tr><th>Order</th><th>Product</th><th>Customer</th><th>Status</th><th>When</th><th>Actions</th></tr></thead><tbody>${filtered.map(o=>`<tr><td>${o.id}</td><td style="min-width:160px">${escapeHtml(o.productName)} x${o.qty}</td><td>${escapeHtml(o.customerName)}<br/><small>${escapeHtml(o.customerPhone)}</small></td><td><span class="chip">${escapeHtml(o.status)}</span></td><td>${new Date(o.createdAt).toLocaleString()}</td><td class="actions"><button onclick="viewOrder('${o.id}')">View</button><button onclick="progressOrder('${o.id}')">Progress</button><button onclick="approveOrder('${o.id}')">Approve</button><button onclick="undoOrder('${o.id}')">Undo</button></td></tr>`).join('')}</tbody></table>` : '<div class="small">No orders</div>';
}

function viewOrder(id){ const o = getOrders().find(x=>x.id===id); if(!o) return alert('Order not found'); openModal(`<h3>Order ${o.id}</h3><div><strong>Product:</strong> ${escapeHtml(o.productName)} x${o.qty}</div><div><strong>Customer:</strong> ${escapeHtml(o.customerName)} — ${escapeHtml(o.customerPhone)}</div><div><strong>Note:</strong> ${escapeHtml(o.note||'-')}</div><div><strong>Status:</strong> ${escapeHtml(o.status)}</div><div style="margin-top:10px"><strong>History:</strong>${(o.history||[]).map(h=>`<div style="font-size:13px">${escapeHtml(h.status)} — ${new Date(h.at).toLocaleString()}</div>`).join('')}</div><div style="display:flex;gap:8px;margin-top:12px"><button class="btn-primary" onclick="closeModal()">Close</button></div></div>`); }

function approveOrder(id){ const orders=getOrders(); const o=orders.find(x=>x.id===id); if(!o) return; const prev=o.status; o.status='Confirmed'; o.history=o.history||[]; o.history.push({at:now(),status:'Confirmed'}); o._lastAction={type:'statusChange',prev}; saveOrders(orders); renderOrders(); addLog(`Order ${id} approved`); // notify user
  const m={id:uid(),from:'admin',to:o.customerPhone,text:`Your order ${o.id} has been confirmed.`,time:now(),read:false}; const ms=getMessages(); ms.push(m); saveMessages(ms); }

function progressOrder(id){ const orders=getOrders(); const o=orders.find(x=>x.id===id); if(!o) return; const options=['Pending','Confirmed','Preparing','Shipped','Delivered','Received','Cancelled']; const s=prompt('Set status', o.status); if(!s) return; if(!options.includes(s)){ alert('Invalid status'); return; } const prev=o.status; o.status=s; o.history=o.history||[]; o.history.push({at:now(),status:s}); o._lastAction={type:'statusChange',prev}; saveOrders(orders); renderOrders(); addLog(`Order ${id} -> ${s}`); const m={id:uid(),from:'admin',to:o.customerPhone,text:`Your order ${o.id} status updated to ${s}`,time:now(),read:false}; const ms=getMessages(); ms.push(m); saveMessages(ms); }

function undoOrder(id){ const orders=getOrders(); const o=orders.find(x=>x.id===id); if(!o||!o._lastAction){ alert('Nothing to undo'); return; } const a=o._lastAction; if(a.type==='statusChange'){ o.status = a.prev; o.history=o.history||[]; o.history.push({at:now(),status:o.status}); delete o._lastAction; saveOrders(orders); renderOrders(); addLog(`Undo applied to ${id}`); const m={id:uid(),from:'admin',to:o.customerPhone,text:`Update: previous status restored for order ${o.id}`,time:now(),read:false}; const ms=getMessages(); ms.push(m); saveMessages(ms); } }

/* ===== Products management (upload image or URL) ===== */
function renderProducts(){ const ps=getProducts(); const area=document.getElementById('productsArea'); if(!area) return; area.innerHTML = ps.length? `<table><thead><tr><th></th><th>Product</th><th>Category</th><th>Price</th><th>Stock</th><th>Actions</th></tr></thead><tbody>${ps.map(p=>`<tr><td><img src="${p.image||'https://via.placeholder.com/80'}" class="thumb"/></td><td>${escapeHtml(p.name)}</td><td>${escapeHtml(p.category)}</td><td>KSh ${p.price}</td><td>${p.stock||0}</td><td><button onclick="editProduct('${p.id}')">Edit</button><button onclick="deleteProduct('${p.id}')">Delete</button></td></tr>`).join('')}</tbody></table>` : '<div class="small">No products</div>'; }

function openAddProduct(){ openModal(`<h3>Add Product</h3><div style="display:flex;flex-direction:column;gap:8px"><input id="p_name" placeholder="Name"/><input id="p_price" placeholder="Price" type="number"/><input id="p_cat" placeholder="Category"/><input id="p_image_url" placeholder="Image URL (or leave empty to upload file)"/><div style="display:flex;gap:8px;align-items:center"><label class="btn-ghost" style="cursor:pointer">Upload image<input id="p_image_file" type="file" accept="image/*" style="display:none"/></label><img id="p_preview" class="thumb" src="https://via.placeholder.com/80"/></div><input id="p_stock" placeholder="Stock" type="number"/><textarea id="p_desc" placeholder="Description"></textarea></div><div style="display:flex;gap:8px;margin-top:8px"><button class="btn-primary" id="saveP">Save</button><button class="btn-ghost" onclick="closeModal()">Cancel</button></div>`);
  const fileInput = document.getElementById('p_image_file'); const urlInput = document.getElementById('p_image_url'); const preview = document.getElementById('p_preview');
  fileInput.addEventListener('change', ()=>{
    const f = fileInput.files[0]; if(!f) return; const reader = new FileReader(); reader.onload = (e)=>{ preview.src = e.target.result; }; reader.readAsDataURL(f);
  });
  urlInput.addEventListener('input', ()=>{ if(urlInput.value) preview.src = urlInput.value; });
  document.getElementById('saveP').addEventListener('click', ()=>{
    const name=document.getElementById('p_name').value.trim(); if(!name) return alert('Name required'); const price=parseFloat(document.getElementById('p_price').value)||0; const category=document.getElementById('p_cat').value.trim()||'Misc'; const stock=parseInt(document.getElementById('p_stock').value)||0; const desc=document.getElementById('p_desc').value.trim();
    // image: prefer uploaded file preview dataURL, else URL
    let image = preview.src || 'https://via.placeholder.com/400'; if(image && image.startsWith('data:')){
      // dataURL (from file) - ok
    } else if(document.getElementById('p_image_url').value.trim()){
      image = document.getElementById('p_image_url').value.trim();
    }
    const p = {id:uid(),name,price,category,image,stock,desc}; const ps=getProducts(); ps.unshift(p); saveProducts(ps); closeModal(); renderProducts(); addLog(`Product added: ${name}`);
  });
}

function editProduct(id){ const ps=getProducts(); const p=ps.find(x=>x.id===id); if(!p) return alert('not found'); openModal(`<h3>Edit Product</h3><div style="display:flex;flex-direction:column;gap:8px"><input id="ep_name" value="${escapeHtml(p.name)}"/><input id="ep_price" value="${p.price}" type="number"/><input id="ep_cat" value="${escapeHtml(p.category)}"/><input id="ep_image_url" value="${escapeHtml(p.image)}"/><div style="display:flex;gap:8px;align-items:center"><label class="btn-ghost" style="cursor:pointer">Upload image<input id="ep_image_file" type="file" accept="image/*" style="display:none"/></label><img id="ep_preview" class="thumb" src="${p.image||'https://via.placeholder.com/80'}"/></div><input id="ep_stock" value="${p.stock||0}" type="number"/><textarea id="ep_desc">${escapeHtml(p.desc||'')}</textarea></div><div style="display:flex;gap:8px;margin-top:8px"><button class="btn-primary" id="saveEdit">Save</button><button class="btn-ghost" onclick="closeModal()">Cancel</button></div>`);
  const fileInput = document.getElementById('ep_image_file'); const urlInput = document.getElementById('ep_image_url'); const preview = document.getElementById('ep_preview');
  fileInput.addEventListener('change', ()=>{ const f=fileInput.files[0]; if(!f) return; const r=new FileReader(); r.onload=(e)=>{ preview.src=e.target.result; }; r.readAsDataURL(f); });
  urlInput.addEventListener('input', ()=>{ if(urlInput.value) preview.src = urlInput.value; });
  document.getElementById('saveEdit').addEventListener('click', ()=>{ p.name=document.getElementById('ep_name').value.trim(); p.price=parseFloat(document.getElementById('ep_price').value)||0; p.category=document.getElementById('ep_cat').value.trim(); p.image=document.getElementById('ep_preview').src; p.stock=parseInt(document.getElementById('ep_stock').value)||0; p.desc=document.getElementById('ep_desc').value.trim(); saveProducts(ps); closeModal(); renderProducts(); addLog(`Product edited: ${p.name}`); });
}

function deleteProduct(id){ if(!confirm('Delete product?')) return; const ps=getProducts().filter(p=>p.id!==id); saveProducts(ps); renderProducts(); addLog(`Product ${id} deleted`); }

/* ===== Rooms & Messages ===== */
function renderRooms(){ const phones=new Set([...getOrders().map(o=>o.customerPhone), ...getMessages().filter(m=>m.from!=='admin').map(m=>m.from)]); const filter=(document.getElementById('roomFilter')||{}).value||''; const arr=Array.from(phones).filter(p=>!filter||p.includes(filter)); const area=document.getElementById('roomsArea'); if(!area) return; area.innerHTML = arr.length? arr.map(ph=>`<div style="display:flex;justify-content:space-between;align-items:center;padding:8px;border-bottom:1px solid #f5f5f5"><div>${escapeHtml(ph)}</div><div><button onclick="openRoom('${ph}')">Open</button></div></div>`).join('') : '<div class="small">No rooms yet</div>'; }

function openRoom(phone){ const msgs = getMessages().filter(m=> (m.from===phone && m.to==='admin') || (m.from==='admin' && m.to===phone)); openModal(`<h3>Room — ${escapeHtml(phone)}</h3><div id="roomMsgs" style="max-height:320px;overflow:auto;padding:8px;border:1px solid #f3f3f3;background:#fafafa;margin-bottom:8px">${msgs.map(m=>`<div style="padding:6px;border-radius:6px;margin-bottom:6px;background:${m.from==='admin'?'#eafaf0':'#fff'}"><strong>${m.from==='admin'?'Admin':escapeHtml(m.from)}</strong><div style="font-size:14px">${escapeHtml(m.text)}</div><div class="small">${new Date(m.time).toLocaleString()}</div></div>`).join('')}</div><textarea id="roomMsgText" placeholder="Type reply"></textarea><div style="display:flex;gap:8px;margin-top:8px"><button id="sendRoomMsg" class="btn-primary">Send</button><button class="btn-ghost" onclick="closeModal()">Close</button></div>`);
  document.getElementById('sendRoomMsg').addEventListener('click', ()=>{ const text=document.getElementById('roomMsgText').value.trim(); if(!text) return alert('Enter message'); const m={id:uid(),from:'admin',to:phone,text,time:now(),read:false}; const ms=getMessages(); ms.push(m); saveMessages(ms); addLog(`Sent message to ${phone}`); const roomMsgs=document.getElementById('roomMsgs'); roomMsgs.innerHTML += `<div style="padding:6px;border-radius:6px;margin-bottom:6px;background:#eafaf0"><strong>Admin</strong><div style="font-size:14px">${escapeHtml(text)}</div><div class="small">${new Date().toLocaleString()}</div></div>`; document.getElementById('roomMsgText').value=''; }); }

/* ===== Reports ===== */
function renderReports(){
  const orders = getOrders();
  const totalSales = orders
    .filter(o => o.status === 'Received' || o.status === 'Delivered')
    .reduce((s, o) => s + (o.price || 0) * (o.qty || 1), 0);

  const byStatus = {};
  orders.forEach(o => {
    byStatus[o.status] = (byStatus[o.status] || 0) + 1;
  });

  const recent = [...orders]
    .sort((a,b)=> new Date(b.createdAt) - new Date(a.createdAt))
    .slice(0,5);

  const area = document.getElementById('reportsArea');
  area.innerHTML = `
    <div class="report-card">
      <strong>Total Sales:</strong> KSh ${totalSales.toLocaleString()}
    </div>

    <div class="report-card">
      <strong>Orders by Status:</strong>
      ${Object.keys(byStatus).map(s => `
        <div>${s}: ${byStatus[s]}</div>
      `).join('')}
    </div>

    <div class="report-card">
      <strong>Recent Orders</strong>
      ${recent.map(o => `
        <div style="font-size:13px">${o.id} — ${o.productName} (${o.status})</div>
      `).join('')}
    </div>
  `;
}

/* ===== Logs ===== */
function renderLogs(){
  const logs = db.load('mb_logs', []);
  const area = document.getElementById('logs');
  area.innerHTML = logs.map(l =>
    `<div>${new Date(l.at).toLocaleString()} — ${escapeHtml(l.text)}</div>`
  ).join('');
}

function addLog(text){
  const logs = db.load('mb_logs', []);
  logs.unshift({ at: now(), text });
  db.save('mb_logs', logs.slice(0,200)); // keep latest 200 logs
  renderLogs();
}

/* ===== Quick Message ===== */
function sendQuickMessage(){
  const to = document.getElementById('msg_to').value.trim();
  const text = document.getElementById('msg_text').value.trim();
  if(!to || !text) return alert('Enter phone and message');

  const m = { id: uid(), from:'admin', to, text, time: now(), read: false };
  const ms = getMessages(); ms.push(m);
  saveMessages(ms);
  addLog(`Quick message to ${to}`);
  alert('Sent');
}

/* ===== CSV Export / Import ===== */
function exportProductsCSV(){
  const ps = getProducts();
  const rows = [
    ["id","name","price","category","image","stock","desc"].join(","),
    ...ps.map(p => [
      p.id, p.name, p.price, p.category, p.image, p.stock, JSON.stringify(p.desc||"")
    ].map(v=>`"${String(v).replace(/"/g,'""')}"`).join(","))
  ].join("\n");

  downloadFile("products.csv", rows);
}

function handleCSVImport(file, type){
  const reader = new FileReader();
  reader.onload = (e)=>{
    const text = e.target.result;
    const lines = text.split("\n").filter(x=>x.trim());
    lines.shift(); // remove header
    if(type === "products"){
      const newP = [];
      lines.forEach(l=>{
        const parts = parseCSV(l);
        if(parts.length >= 7){
          newP.push({
            id: parts[0], name: parts[1], price: Number(parts[2]),
            category: parts[3], image: parts[4],
            stock: Number(parts[5]), desc: parts[6].replace(/^"|"$/g,"")
          });
        }
      });
      saveProducts(newP);
      renderProducts();
      addLog(`Products CSV imported (${newP.length})`);
    }
  };
  reader.readAsText(file);
}

function downloadFile(name, text){
  const a = document.createElement('a');
  a.href = 'data:text/plain;charset=utf-8,' + encodeURIComponent(text);
  a.download = name;
  a.click();
}

function parseCSV(line){
  const out=[]; let cur=''; let inside=false;
  for(let i=0;i<line.length;i++){
    const c=line[i];
    if(c==='"' && line[i+1]==='"'){ cur+='"'; i++; continue; }
    if(c==='"'){ inside=!inside; continue; }
    if(c===',' && !inside){ out.push(cur); cur=''; continue; }
    cur+=c;
  }
  out.push(cur);
  return out;
}

/* ===== Modal System ===== */
function openModal(html){
  closeModal();
  const m=document.createElement('div');
  m.id='modal';
  m.style=`
    position:fixed;top:0;left:0;right:0;bottom:0;
    background:rgba(0,0,0,0.35);display:flex;
    justify-content:center;align-items:center;
    padding:20px;z-index:9999
  `;
  m.innerHTML = `
    <div style="background:white;border-radius:10px;padding:16px;max-width:500px;width:100%;max-height:90%;overflow:auto;">
      ${html}
    </div>
  `;
  document.body.appendChild(m);
}
function closeModal(){
  const m=document.getElementById('modal');
  if(m) m.remove();
}

/* ===== Escape HTML ===== */
function escapeHtml(t){
  return (t||"").replace(/[&<>"']/g,m=>({
    "&":"&amp;","<":"&lt;",">":"&gt;","\"":"&quot;","'":"&#039;"
  }[m]));
}

/* ===== Start ===== */
render();
</script>
</body>
</html>
